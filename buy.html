<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buy — S O S O V A L U E   S H O P</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo-mini">SV</div>
      <div><div style="font-weight:800">S O S O V A L U E &nbsp;&nbsp; S H O P</div><div class="muted" style="font-size:12px">Buy</div></div>
    </div>
    <nav>
      <a href="index.html">Home</a>
      <a href="shop.html">Shop</a>
      <a href="dashboard.html">Dashboard</a>
    </nav>
  </header>

  <main class="container" style="margin-top:110px;max-width:760px">
    <div class="card">
      <h3 id="buyTitle">Buy</h3>
      <div class="muted" id="buyMeta">Product details</div>

      <div style="margin-top:12px" class="field">
        <label class="muted">Quantity</label>
        <input id="buy_qty" type="number" />
      </div>

      <div style="margin-top:10px" class="field">
        <label class="muted">Referral Link / Code</label>
        <input id="buy_ref" />
      </div>

      <div style="margin-top:10px" class="field">
        <label class="muted">Price</label>
        <div id="buy_price" style="font-weight:800">$0.00</div>
      </div>

      <div style="margin-top:14px;display:flex;gap:10px">
        <button class="btn" onclick="submitBuy()">Confirm Order</button>
        <a class="ghost" href="shop.html">Cancel</a>
      </div>

      <div style="margin-top:12px" class="muted">Price auto-calculates based on product. Orders will be charged from your USD balance.</div>
    </div>
  </main>

  <script src="app.js"></script>
  <script src="calculator.js"></script>
  <script>
    // parse product from query string
    const params = new URLSearchParams(location.search);
    const prodId = params.get('prod') || 'V0';
    const PRODUCTS = {
      V0:{id:'V0',title:'Sosovalue V0 Referral',pricePerUnit:2/1000,min:1000,max:100000000,unit:'referrals'},
      V1:{id:'V1',title:'Sosovalue V1 Referral',pricePerUnit:10/100,min:100,max:10000000,unit:'referrals'},
      V2:{id:'V2',title:'Sosovalue V2 Referral',pricePerUnit:15/100,min:50,max:1000000,unit:'referrals'},
      REBATE:{id:'REBATE',title:'Rebate EXP',pricePerUnit:1/1000000,min:1000000,max:1000000000,unit:'exp'}
    };
    const P = PRODUCTS[prodId] || PRODUCTS.V0;
    document.getElementById('buyTitle').textContent = `Buy — ${P.title}`;
    document.getElementById('buyMeta').textContent = `${P.id} • ${P.unit} • Min ${P.min.toLocaleString()} • Max ${P.max.toLocaleString()}`;

    const qtyEl = document.getElementById('buy_qty');
    const priceEl = document.getElementById('buy_price');
    qtyEl.value = P.min;

    function compute() {
      const q = Number(qtyEl.value)||0;
      const price = calculatePriceClient(P, q);
      priceEl.textContent = `$${price.toFixed(2)}`;
    }
    qtyEl.addEventListener('input', compute);
    compute();

    async function submitBuy(){
      const qty = Number(qtyEl.value)||0;
      const ref = document.getElementById('buy_ref').value.trim();
      if(qty < P.min || qty > P.max){ alert(`Quantity must be between ${P.min.toLocaleString()} and ${P.max.toLocaleString()}`); return; }
      if(!ref){ alert('Referral link required'); return; }
      // call same local client-side confirm function used earlier in app.js
      if(typeof confirmBuy === 'function'){ confirmBuy(P.id); return; }
      // fallback: store order locally (if app.js missing)
      const session = JSON.parse(localStorage.getItem('sv_session')||'null');
      if(!session){ alert('Please login first'); location.href='login.html'; return; }
      const users = JSON.parse(localStorage.getItem('sv_users')||'[]');
      const me = users.find(u=>u.id===session.id);
      const price = calculatePriceClient(P, qty);
      if(!me || me.balance < price){ if(confirm('Insufficient balance. Add funds now?')) location.href='addbalance.html'; return; }
      me.balance = Number((me.balance - price).toFixed(2));
      localStorage.setItem('sv_users', JSON.stringify(users));
      const orders = JSON.parse(localStorage.getItem('sv_orders')||'[]');
      const order = {id:'ORD'+Date.now(),userId:me.id,product:P.id,qty,price,referral:ref,status:'PENDING',created:Date.now()};
      orders.unshift(order); localStorage.setItem('sv_orders', JSON.stringify(orders));
      alert('Order created. Check Orders page.'); location.href='orders.html';
    }
  </script>
</body>
</html>
